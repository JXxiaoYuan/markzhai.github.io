<body>
<div id="info">Waiting...</div>
<script>
(function () {
  var testTimes = 100;
  var bufferSize = 1024 * testTimes;
  var bufferForCovert = new Int32Array(bufferSize);
  var bufferForForget = new Int32Array(bufferSize);
  var bufferForJunk = new Int32Array(bufferSize);
  var i, last_diff, infoElement;
  function testForCacheDiff(bufferForCovert, bufferForForget, bufferForJunk) {
    "use strict"
    var i, j, mix_i, j_index, loadedJunk, t1, t2, average_cache_miss, average_cache_diff;
    var times = new Float64Array(testTimes);
    var totalDiffTime = new Float64Array(testTimes);
    var vaildTestTime = 0;
    for (i = 0; i < testTimes; i++) {
      for (j = 0; j < bufferSize; ++j) {
        loadedJunk = bufferForForget[j];
        bufferForJunk[j] = loadedJunk;
      }
      mix_i = (((i * 167) + 13) & testTimes);
      loadedJunk = bufferForCovert[mix_i * 1024];
      bufferForJunk[mix_i * 1024] = loadedJunk;
      for (j = 0; j < testTimes; ++j) {
        t1 = performance.now();
        j_index = j * 1024;
        loadedJunk = bufferForCovert[j_index];
        t2 = performance.now();
        // smaller j for minize the cache overhead.
        bufferForJunk[j] = loadedJunk;
        times[j] = t2 - t1;
      }
      average_cache_miss = 0.0;
      for (j = 0; j < testTimes; ++j) {
        if (j == mix_i)
          continue;
        average_cache_miss += times[j];
      }
      average_cache_miss /= testTimes - 1
      totalDiffTime[i] = average_cache_miss - times[mix_i];
    }
    average_cache_diff = 0.0;
    for (i = 0; i < testTimes; ++i) {
      if (totalDiffTime[i] > 0.0) {
        average_cache_diff += totalDiffTime[i];
        vaildTestTime++;
      }
    }
    return [average_cache_diff / vaildTestTime, vaildTestTime];
  }

  for (i = 0; i < 10; ++i) {
    last_diff = testForCacheDiff(bufferForCovert, bufferForForget, bufferForJunk);
  }
  infoElement = document.getElementById("info")
  infoElement.innerText = "last_diff = " + last_diff[0] + "; vaildTestTime = " + last_diff[1];
})()
</script>
</body>
